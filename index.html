<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>playlist</title>
    <style>
      body,
      a {
        color: lime;
      }
      body {
        background: black;
        font-family: monospace;
        margin: 0;
      }
      a {
        text-decoration: none;
      }
      a.active,
      a:hover {
        color: white;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      thead {
        position: sticky;
        top: 0;
      }
      th {
        text-align: left;
        background: darkgreen;
      }
      tr:nth-child(even) {
        background-color: #202020;
      }
      td {
        border-top: 1px solid darkgreen;
      }
      th,
      td {
        padding: 0.5em 2em;
      }
    </style>
  </head>

  <body>
    <table>
      <thead id="columns"></thead>
      <tbody id="rows">
        <tr>
          <td>Loading...</td>
        </tr>
      </tbody>
    </table>
    <script type="module">
      const res = await fetch("./playlist.json");
      const playlist = await res.json();
      const columnsEl = document.getElementById("columns");
      const rowsEl = document.getElementById("rows");

      const columns = {
        artist_ids: "Artist(s)",
        title: "Title",
        addedAt: "Added On",
      };

      const renderColumns = (hashKey, direction) => {
        const columnEls = [];
        Object.entries(columns).forEach(([key, value]) => {
          const th = document.createElement("th");
          const href = `#${key}.${direction === "asc" ? "desc" : "asc"}`;
          const className = hashKey === key ? "active" : "";

          th.innerHTML = `<a href="${href}" class="${className}">${value}</a>`;
          columnEls.push(th);
        });
        columnsEl.replaceChildren(...columnEls);
      };

      const parseValue = (key, track) =>
        ((
          {
            artist_ids: (track) =>
              track[key]
                .map(
                  (id) =>
                    `<a href="spotify:artist:${id}">${playlist.artists[id]}</a>`
                )
                .join(", "),
            title: (track) =>
              `<a href="spotify:track:${track.id}">${track.title}</a>`,
            addedAt: (track) => new Date(track[key]).toISOString().slice(0, 10),
          }[key] || ((track) => track[key])
        )(track));

      const renderRows = () => {
        const rowEls = [];
        playlist.tracks.forEach((track) => {
          const tr = document.createElement("tr");
          Object.keys(columns).forEach((key) => {
            const td = document.createElement("td");
            td.innerHTML = parseValue(key, track);
            tr.appendChild(td);
          });
          rowEls.push(tr);
        });
        rowsEl.replaceChildren(...rowEls);
      };

      const getArtistNames = (track) =>
        track.artist_ids.map((id) => playlist.artists[id]).toString();

      const sortBy = (key, direction) => {
        playlist.tracks.sort((a, b) =>
          key === "artist_ids"
            ? getArtistNames(a).localeCompare(getArtistNames(b))
            : a[key].toString().localeCompare(b[key].toString())
        );
        if (direction === "desc") {
          playlist.tracks.reverse();
        }
      };

      const render = () => {
        const hash = window.location.hash || "#addedAt.desc";
        const [hashKey, direction] = hash.slice(1).split(".");
        sortBy(hashKey, direction);
        renderColumns(hashKey, direction);
        renderRows();
      };

      window.addEventListener("hashchange", () => {
        render();
      });

      render();
    </script>
  </body>
</html>
